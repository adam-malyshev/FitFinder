<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/page/stylesheets/style.css" >
  <script src="https://kit.fontawesome.com/3f0816ae9e.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header">
  <h2>fitfinder</h2>
</div>
<div class="topnav">
  <a href="/wardrobe" class="active">Wardrobe</a>
  <!--<a href="/prefrences"> Prefrences </a>-->
  <a href="/logout" class="account"> Log Out </a>
</div>



<div class="content">
    <a href='/wardrobe' style='float:right; width:10px; height:10px;' ><i class='far fa-window-close'></i></a>
    <p>Add Clothes:</p>
    <form action="/add" method="post" id="frm1" enctype="multipart/form-data">
      <label for="image">Image:</label>
      <div class='image'>
          <div id="img"></div>
          <input type="file" name="image" required id="imageUpload">
      </div>
      <input class="text" type="text" name="color" id ="color" required placeholder="Color">
      <input class="button" type="submit" value="Add Item">

    </form>
    <br>
    <br>
    <div id="edit"></div>
</div>
    <br>
<div style="overflow-x:auto;" id="clothes" class="table" ></div>

<script>

    var data;
    function filePreview(evt) {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            var files = evt.target.files;

            var result = '';
            var file;
            for (var i = 0; file = files[i]; i++) {
                // if the file is not an image, continue
                if (!file.type.match('image.*')) {
                    continue;
                }

                reader = new FileReader();
                reader.onload = (function (tFile) {
                    return function (evt) {
                        document.getElementById('img').innerHTML = '<img style="width:100px; height:100px;" src="' + evt.target.result + '" />';
                    };
                }(file));
                reader.readAsDataURL(file);
            }
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }
    }
document.getElementById('imageUpload').addEventListener('change', filePreview, false);


	function addRow(obj){

		var out = "<tr>";
		out += "<td><canvas id='"+String(obj.id)+"' width='100' height='100'></canvas>";
		out += "<td style='width:100%'>" + obj.name + "</td>";
		out += "<td style='width:100%'>" + obj.type + "</td>";
		out += "<td style='width:100%'>" + obj.color + "</td>";
		out += "<td style='width:30px'><button onclick='del(" + obj.id+ ")'> <i class='fas fa-trash-alt'></i> </button></td>";
		out += "<td style='width:30px'><button onclick='edit(" + obj.id + ")'> <i class='fas fa-edit'></i> </button></td>";
		out += "</tr>";

		console.log(obj.id);
		return out;
	}
	function del(id){
		var xhd = new XMLHttpRequest();

		xhd.onreadystatechange = function() {
		    if (xhd.readyState === 4){
		    	var data = JSON.parse(xhd.responseText);
		        document.getElementById('clothes').innerHTML = table(data);
                data.forEach((item) => {
                    insertImage(item);
                });
		    }
		};
		xhd.open("GET", "/delete?id="+String(id));
		xhd.send();
	};

	function edit(id) {
		console.log(id);
		var x = "<a href='/wardrobe' style='float:right; width:10px; height:10px; text-decoration: none;' ><i class='far fa-window-close'></i></a> <form action='/edit?id=" + id + "' method='post' id='frm1' enctype='multipart/form-data'> <input class='text' type='text' name='name' id='name' placeholder='Name'><select name='type' id='type'><option value='shirt'>Shirt</option><option value='pants'>Pants</option></select><input class='text' type='text' name='color' id ='color' placeholder='Color'><label for='image'> Image: </label> <input type='file' name='image' id='image'><input class='button' type='button' onclick='post(this)' value='Update'></form>"
		document.getElementById('edit').innerHTML = x;

	}

	function table(obj){
		var list_html = "<table>";

        list_html += "<tr>";
        list_html += "<th>Image</th>";
        list_html += "<th>Name</th>";
        list_html += "<th>Type</th>";
        list_html += "<th>Color</th>";
        list_html += "<th> </th>";
        list_html += "<th> </th>";
        list_html += "</tr>";

	    for(var i=0;i<obj.length;i++){

	    	list_html += addRow(obj[i]);
	    }

	    list_html += "</table>";
	    return list_html;
	}

    function insertImage (obj) {
        var canvas = document.getElementById(String(obj.id));
        var context = canvas.getContext('2d');
        var image = new Image();

        image.onload = () => {
            var sourcex = obj.bounding_box.x0;
            var sourcey = obj.bounding_box.y0;
            var sourcewidth = obj.bounding_box.x1 - obj.bounding_box.x0;
            var sourceheight = obj.bounding_box.y1 - obj.bounding_box.y0;
            var destwidth = sourcewidth;
            var destheight = sourceheight;
            var destx = canvas.width / 2 - destwidth / 2;
            var desty = canvas.height / 2 - destheight / 2;
            context.drawImage(image, sourcex, sourcey, sourcewidth, sourceheight, destx, desty, destwidth, destheight);
        }
        image.src = obj.imgUrl;
    }
    var interval;
    function view() {

    	var xhr = new XMLHttpRequest();

    	xhr.onreadystatechange = function() {
    	    if (xhr.readyState === 4){
    	      data = JSON.parse(xhr.responseText);
    	      document.getElementById('clothes').innerHTML = table(data);
              data.forEach((item) => {
                  insertImage(item);
              });
              console.log(Object.keys(data[data.length-1]).length);

    	    }
    	};
        xhr.open('GET', '/view');
    	xhr.send();

    }
    view();
    setInterval(function () {
        if(data[data.length - 1].name == "Loading..."){
            view();
        }

    }, 5000);

</script>

</body>
</html>
